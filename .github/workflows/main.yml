name: Export Azure Daily Cost with Alerts

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  export-cost:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Dates and Token
      id: vars
      run: |
        # วันที่ของข้อมูล (เมื่อวาน)
        echo "USAGE_DATE_FILE=$(date -d 'yesterday' +'%Y%m%d')" >> $GITHUB_ENV
        echo "USAGE_DATE_ISO=$(date -d 'yesterday' +'%Y-%m-%d')" >> $GITHUB_ENV
        
        # ช่วงเวลาสำหรับดึงข้อมูล 2 วันย้อนหลัง (เพื่อเปรียบเทียบ)
        echo "START_PERIOD=$(date -d '2 days ago' +'%Y-%m-%dT00:00:00Z')" >> $GITHUB_ENV
        echo "END_PERIOD=$(date -d 'yesterday' +'%Y-%m-%dT23:59:59Z')" >> $GITHUB_ENV
        
        ACCESS_TOKEN=$(az account get-access-token --query accessToken -o tsv)
        echo "::add-mask::$ACCESS_TOKEN"
        echo "AUTH_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
        echo "SUB_ID=$(az account show --query id -o tsv)" >> $GITHUB_ENV
        echo "SUB_NAME=$(az account show --query name -o tsv)" >> $GITHUB_ENV

    - name: Query 2-Day Cost via REST API
      run: |
        # ดึงข้อมูลย้อนหลัง 2 วันแบบรายวัน (Granularity: Daily)
        curl -X POST "https://management.azure.com/subscriptions/${{ env.SUB_ID }}/providers/Microsoft.CostManagement/query?api-version=2023-03-01" \
        -H "Authorization: Bearer ${{ env.AUTH_TOKEN }}" \
        -H "Content-Type: application/json" \
        -d '{
          "type": "Usage",
          "timeframe": "Custom",
          "timePeriod": { "from": "${{ env.START_PERIOD }}", "to": "${{ env.END_PERIOD }}" },
          "dataset": {
            "granularity": "Daily",
            "aggregation": { "totalCost": { "name": "PreTaxCost", "function": "Sum" } },
            "grouping": [
              { "type": "Dimension", "name": "ResourceGroup" },
              { "type": "Dimension", "name": "ServiceName" },
              { "type": "Dimension", "name": "ResourceLocation" },
              { "type": "Dimension", "name": "ResourceId" },
              { "type": "Dimension", "name": "Meter" }
            ]
          }
        }' -o raw_cost.json

    - name: Calculate Percentage Change and Alert
      id: calc
      run: |
        # 1. คำนวณผลรวมของเมื่อวาน (Yesterday)
        YESTERDAY_TOTAL=$(jq -r --arg dt "${{ env.USAGE_DATE_ISO }}" '.properties.rows[] | select(.[1] == ($dt + "T00:00:00")) | .[0]' raw_cost.json | awk '{s+=$1} END {print s+0}')
        
        # 2. คำนวณผลรวมของวันก่อนหน้า (Day Before Yesterday)
        PREV_DATE=$(date -d '2 days ago' +'%Y-%m-%d')
        PREV_TOTAL=$(jq -r --arg dt "$PREV_DATE" '.properties.rows[] | select(.[1] == ($dt + "T00:00:00")) | .[0]' raw_cost.json | awk '{s+=$1} END {print s+0}')
        
        # 3. คำนวณ % Change และเช็ค Alert
        # สูตร: ((New - Old) / Old) * 100
        if (( $(echo "$PREV_TOTAL > 0" | bc -l) )); then
          PCT_CHANGE=$(echo "scale=2; (($YESTERDAY_TOTAL - $PREV_TOTAL) / $PREV_TOTAL) * 100" | bc -l)
        else
          PCT_CHANGE=0
        fi
        
        IS_ALERTS="NO"
        if (( $(echo "$PCT_CHANGE > 50" | bc -l) )); then IS_ALERTS="YES"; fi
        
        echo "PCT_CHANGE=$PCT_CHANGE%" >> $GITHUB_ENV
        echo "IS_ALERTS=$IS_ALERTS" >> $GITHUB_ENV

    - name: Convert to CSV with Alert Columns
      run: |
        FILENAME="${{ env.USAGE_DATE_FILE }}_${{ env.SUB_ID }}_dailycost.csv"
        echo "FILENAME=$FILENAME" >> $GITHUB_ENV

        # สร้าง Header ใหม่
        echo "ReportDate,UsageDate,SubscriptionName,PreTaxCost,Currency,Diff_Percent,Is_Alerts,ResourceLocation,ServiceName,ResourceGroup,Meter,ResourceId" > "$FILENAME"
        
        # กรองเอาเฉพาะข้อมูลของเมื่อวานมาลง CSV และใส่ค่าคำนวณลงไปทุกแถว
        jq -r --arg sub "${{ env.SUB_NAME }}" --arg dt "${{ env.USAGE_DATE_ISO }}" \
              --arg pct "${{ env.PCT_CHANGE }}" --arg alt "${{ env.IS_ALERTS }}" \
        '.properties.rows[] | select(.[1] == ($dt + "T00:00:00")) | [.[1], .[1], $sub, .[0], .[7], $pct, $alt, .[4], .[3], .[2], .[6], .[5]] | @csv' \
        raw_cost.json >> "$FILENAME"

    - name: Send Email with Alert Status
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        secure: false
        username: ${{ secrets.GMAIL }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: "[${{ env.IS_ALERTS == 'YES' && 'ALERT' || 'Normal' }}] Azure Cost Report - ${{ env.USAGE_DATE_ISO }}"
        to: ${{ secrets.MAIL_RECIPIENTS }}
        from: Azure Billing Automation
        body: |
          รายงานค่าใช้จ่ายประจำวันที่: ${{ env.USAGE_DATE_ISO }}
          -----------------------------------------------
          Subscription: ${{ env.SUB_NAME }}
          สรุปการเปลี่ยนแปลง: ${{ env.PCT_CHANGE }} (เทียบกับวันก่อนหน้า)
          สถานะ Alert: ${{ env.IS_ALERTS }}
          -----------------------------------------------
          (รายละเอียดแยกตามราย Resource อยู่ในไฟล์แนบ)
        attachments: "${{ env.FILENAME }}"
