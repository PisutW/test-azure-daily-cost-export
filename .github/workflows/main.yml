name: Export Azure Daily Cost

on:
  schedule:
    # รันทุกวันตอน 7 โมงเช้า (UTC+7)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  export-cost:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # --- ส่วนที่เพิ่มเข้ามา (แก้ไขปัญหา Error) ---
    - name: Install Cost Management Extension
      run: az extension add --name costmanagement
    # ----------------------------------------

    - name: Get Date for Filename
      id: date
      run: |
        echo "TODAY=$(TZ='Asia/Bangkok' date +'%Y%m%d')" >> $GITHUB_ENV
        # ดึงข้อมูลของ "เมื่อวาน" (เพื่อให้ได้ Cost เต็มวัน)
        echo "START_DATE=$(date -d 'yesterday' +'%Y-%m-%dT00:00:00Z')" >> $GITHUB_ENV
        echo "END_DATE=$(date -d 'yesterday' +'%Y-%m-%dT23:59:59Z')" >> $GITHUB_ENV

    - name: Query Cost and Save CSV
      id: query
      run: |
        # รันคำสั่ง Query หลังจากลง Extension แล้ว
        az costmanagement query \
          --type Usage \
          --timeframe Custom \
          --time-period from=$START_DATE to=$END_DATE \
          --dataset-aggregation {"totalCost":{"name":"PreTaxCost","function":"Sum"}} \
          --dataset-grouping name="ServiceName" type="Dimension" \
          --output csv > temp_cost.csv

        # เปลี่ยนชื่อไฟล์
        mv temp_cost.csv ${{ env.TODAY }}_subscription_dailycost.csv
        
        echo "File created: ${{ env.TODAY }}_subscription_dailycost.csv"

    - name: Upload CSV as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: daily-cost-file
        path: ${{ env.TODAY }}_subscription_dailycost.csv
        retention-days: 30
