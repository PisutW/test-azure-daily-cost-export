name: Azure Final Report

on:
  schedule:
    - cron: '13 2 * * *' # รันตอน 09:13 น. เวลาไทย
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  export-cost:
    runs-on: ubuntu-latest
    
    steps:
    - run: echo "If you see this in Actions, the file path and branch are correct."
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Dates and Token
      id: vars
      run: |
        # สร้างวันที่แบบ YYYYMMDD เพื่อใช้เปรียบเทียบ (แม่นยำที่สุด)
        echo "YESTERDAY_STR=$(date -d 'yesterday' +'%Y%m%d')" >> $GITHUB_ENV
        echo "PREV_STR=$(date -d '2 days ago' +'%Y%m%d')" >> $GITHUB_ENV
        echo "YESTERDAY_ISO=$(date -d 'yesterday' +'%Y-%m-%d')" >> $GITHUB_ENV
        
        # ช่วงเวลาดึงข้อมูล 2 วัน
        echo "START_PERIOD=$(date -d '2 days ago' +'%Y-%m-%dT00:00:00Z')" >> $GITHUB_ENV
        echo "END_PERIOD=$(date -d 'yesterday' +'%Y-%m-%dT23:59:59Z')" >> $GITHUB_ENV
        
        ACCESS_TOKEN=$(az account get-access-token --query accessToken -o tsv)
        echo "::add-mask::$ACCESS_TOKEN"
        echo "AUTH_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
        echo "SUB_ID=$(az account show --query id -o tsv)" >> $GITHUB_ENV
        echo "SUB_NAME=$(az account show --query name -o tsv)" >> $GITHUB_ENV

    - name: Query 2-Day Cost via REST API
      run: |
        curl -X POST "https://management.azure.com/subscriptions/${{ env.SUB_ID }}/providers/Microsoft.CostManagement/query?api-version=2023-03-01" \
        -H "Authorization: Bearer ${{ env.AUTH_TOKEN }}" \
        -H "Content-Type: application/json" \
        -d '{
          "type": "Usage",
          "timeframe": "Custom",
          "timePeriod": { "from": "${{ env.START_PERIOD }}", "to": "${{ env.END_PERIOD }}" },
          "dataset": {
            "granularity": "Daily",
            "aggregation": { "totalCost": { "name": "PreTaxCost", "function": "Sum" } },
            "grouping": [
              { "type": "Dimension", "name": "ResourceGroup" },
              { "type": "Dimension", "name": "ServiceName" },
              { "type": "Dimension", "name": "ResourceLocation" },
              { "type": "Dimension", "name": "ResourceId" },
              { "type": "Dimension", "name": "Meter" }
            ]
          }
        }' -o raw_cost.json

    - name: Process CSV with Line-Item Comparison
      run: |
        FILENAME="${{ env.YESTERDAY_STR }}_${{ env.SUB_ID }}_dailycost.csv"
        echo "FILENAME=$FILENAME" >> $GITHUB_ENV

        # สร้าง Header
        echo "ReportDate,UsageDate,SubscriptionName,PreTaxCost,Currency,Diff_Percent,Is_Alerts,ResourceLocation,ServiceName,ResourceGroup,Meter,ResourceId" > "$FILENAME"
        
        # ปรับปรุง Logic jq: 
        # 1. ทำความสะอาดวันที่ (ลบ - และ T ออกให้เหลือแค่ตัวเลข 8 หลัก)
        # 2. ทำ Mapping วันก่อนหน้า
        # 3. เทียบกับเมื่อวาน
        jq -r --arg yesterday "${{ env.YESTERDAY_STR }}" \
              --arg prevday "${{ env.PREV_STR }}" \
              --arg sub "${{ env.SUB_NAME }}" \
              --arg report_date "${{ env.YESTERDAY_ISO }}" \
        '
        def clean_date: . | tostring | gsub("[-T:Z]"; "") | .[0:8];
        ( [.properties.rows[] | select((.[1] | clean_date) == $prevday) | {key: (.[5] + .[6]), value: .[0]}] | from_entries ) as $prev_map |
        .properties.rows[] | select((.[1] | clean_date) == $yesterday) |
        (.[5] + .[6]) as $key |
        (if $prev_map[$key] then
            (($prev_map[$key] | tonumber) as $old | (.[0] | tonumber) as $new |
             if $old > 0 then (($new - $old) / $old * 100 | round) else 0 end)
         else "NEW" end) as $diff |
        (if $diff == "NEW" then "NEW"
         elif ($diff | tonumber) > 50 then "YES"
         else "NO" end) as $alert |
        [$report_date, $report_date, $sub, .[0], .[7], (if $diff == "NEW" then 0 else ($diff | tostring + "%") end), $alert, .[4], .[3], .[2], .[6], .[5]] | @csv
        ' raw_cost.json >> "$FILENAME"

    - name: Check for Critical Alerts
      id: check_alert
      run: |
        if grep -q "YES" "${{ env.FILENAME }}"; then
          echo "HAS_ALERT=true" >> $GITHUB_ENV
        else
          echo "HAS_ALERT=false" >> $GITHUB_ENV
        fi

    - name: Send Email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        secure: false
        username: ${{ secrets.GMAIL }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: "[${{ env.HAS_ALERT == 'true' && 'ALERT' || 'Normal' }}] Azure Detailed Cost - ${{ env.YESTERDAY_ISO }}"
        to: ${{ secrets.MAIL_RECIPIENTS }}
        from: Azure Billing Automation
        body: |
          รายงานค่าใช้จ่าย Azure วันที่: ${{ env.YESTERDAY_ISO }}
          -----------------------------------------------
          Subscription: ${{ env.SUB_NAME }}
          -----------------------------------------------
          * ดูรายละเอียดในไฟล์แนบ
          * หากไฟล์แนบไม่มีข้อมูล อาจเกิดจากข้อมูล Cost ของ Azure ยังไม่อัปเดตในระบบ API
        attachments: "${{ env.FILENAME }}"
